<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>文件下载代理服务</title>
<link type="favicon" rel="shortcut icon" href="favicon.ico" />

<!-- Loading Bootstrap -->
<link href="css/bootstrap.min.css" rel="stylesheet">
<!-- Loading Flat UI Pro -->
<link href="css/flat-ui.min.css" rel="stylesheet">
<link href="css/style.css" rel="stylesheet">
<!-- Loading jquery -->
<script src="js/jquery-1.11.0.min.js" type="text/javascript"></script>
<script>
	String.prototype.startWith = function(str) {     
		var reg = new RegExp("^"+str);     
		return reg.test(this);        
	}
	String.prototype.endWith = function(str) {     
		var reg = new RegExp(str + "$");     
		return reg.test(this);        
	}
	function isEmpty(obj){
		if(typeof obj == "undefined" || obj == null || obj == ""){
			return true;
		}else{
			return false;
		}
	}

	headerData2Json = function() {
		var json = [];
		$("#mytable > tbody").find("tr").each(function() {
			var tdArr = $(this).children();
			var key = tdArr.eq(0).find('input').val();
			var value = tdArr.eq(1).find('input').val();

       		var j = {};
			if (!isEmpty(key) && !isEmpty(value)) {
				j[key] = value;
				json.push(j);
			}
		});
		return JSON.stringify(json);
	}

	getToken = function(url, name, cookie, header, callback) {
		var postdata = {}

		postdata.url = url;
		if (!isEmpty(name))
			postdata.filename = name;
		if (!isEmpty(cookie))
			postdata.cookie = cookie;	
		if (!isEmpty(header) && header != "[]")
			postdata.headers = header;	

		postdata.urldecode = $('#checkbox-urldecode').prop('checked');
  		$.ajax({
			url: '/api/getToken',
			type: 'POST',
			data: JSON.stringify(postdata),
			async: false,
			success: function (json) {
				if (json.code != 0) { //出错的时候
					callback.error(json.message);
				} else { 
					callback.success(json);
				}
			},
			error: function (data) {
				callback.error("服务器内部错误");
			}
    	});
  	}

	showFailed = function(msg) {
		$('#alert-failed').show(400);
		$('#failed-msg').text(msg);
		setTimeout("$('#alert-failed').hide(400)","2000");
  	}
</script>
</head>
<body>
	<div id="box"></div>
	<div class="container">
	<div class="header clearfix">
	  <h3 class="title">文件下载代理服务</h3>
	</div>

	<div class="jumbotron">
		<div class="form-group form-group-search">
		  <div class="input-group">
		  	<input type="search" class="form-control" id="search" placeholder="请输入URL">
		    <span id="query-btn" class="input-group-addon search-btn btn btn-success">GO</span>
			</div>
		</div>

		<div id="alert-failed" class="alert alert-danger">
			<strong id="failed-msg"></strong>
		</div>

		<div id="result-info" class="alert alert-success">
			<strong>下载地址: </strong><a target="_blank" id="result-url"></a><br/>
			<strong>创建时间: </strong><b id="result-create"></b><br/>
			<strong>过期时间: </strong><b id="result-expire"></b>
		</div>

		<div id="check-group">
			<label class="checkbox" for="checkbox-urldecode">
					<input type="checkbox" value="" id="checkbox-urldecode" data-toggle="checkbox" class="custom-checkbox"><span class="icons"><span class="icon-unchecked"></span><span class="icon-checked"></span></span>
					URL解码
			</label>&nbsp;&nbsp;
			<label class="checkbox" for="checkbox-name">
					<input type="checkbox" value="" id="checkbox-name" data-toggle="checkbox" class="custom-checkbox"><span class="icons"><span class="icon-unchecked"></span><span class="icon-checked"></span></span>
					自定义文件名
			</label>&nbsp;&nbsp;
			<label class="checkbox" for="checkbox-cookie">
					<input type="checkbox" value="" id="checkbox-cookie" data-toggle="checkbox" class="custom-checkbox"><span class="icons"><span class="icon-unchecked"></span><span class="icon-checked"></span></span>
					自定义Cookies
			</label>&nbsp;&nbsp;
			<label class="checkbox" for="checkbox-header">
					<input type="checkbox" value="" id="checkbox-header" data-toggle="checkbox" class="custom-checkbox"><span class="icons"><span class="icon-unchecked"></span><span class="icon-checked"></span></span>
					自定义Header
			</label>&nbsp;&nbsp;
			
		</div>

		<div id="input-group-custom">
			<input type="search" class="form-control" id="input-name" placeholder="请输入自定义文件名">
			<input type="search" class="form-control" id="input-cookie" placeholder="请输入自定义Cookies">
		</div>

		<div id="custom-header-group" class="row">
			<div class="col-md-12" style="padding:2em 0;">
				<div class="table-responsive">
					<table class="table table-bordered table-striped" id="mytable">
						<thead>
							<tr>
							<th>自定义HEADER键</th>
							<th>自定义HEADER值</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				</div>
			</div>
			<div class="col-md-12"  style="padding-bottom:2em;">
				<button class="btn btn-info" id="add"></i>添加自定义HEADER</button>
			</div>
		</div>
		<!--<div id="detail">
			
		</div> -->
	</div>
	<script>
	$(document).ready(function () {
		$('#input-group-custom > input').hide();
		$('#checkbox-urldecode').prop("checked",true);

		$('#query-btn').click(function() {
			var url = $('#search').val();
			if (url == "" || url == "http://" || url == "https://") {
				showFailed("请输入URL！");
				return;
			}

			if (!url.startsWith("http://") && !url.startsWith("https://")) {
				showFailed("请输入正确的URL！ URL以 \"http://\" 或 \"https://\" 开头");
				return;
			}

			$('#result-info').hide('500');
			
			var name = "";
			var cookie = "";
			var header = "";
			if ($('#checkbox-name').prop('checked')) {
				var text = $('#input-name').val()
				if (isEmpty(text)) {
					$('#checkbox-name').prop('checked', false);
					$('#checkbox-name').trigger("change");
				} else
					name = text;

			} else {
				var a = url.lastIndexOf('/');
				if (a != -1 && url.indexOf('.', a) != -1)
					name = url.substring(a + 1, url.length);
			}


			if ($('#checkbox-cookie').prop('checked')) {
				var text = $('#input-cookie').val()
				if (isEmpty(text)) {
					$('#checkbox-cookie').prop('checked', false);
					$('#checkbox-cookie').trigger("change");
				} else
					cookie = text;

			}

			if ($('#checkbox-header').prop('checked')) {
				var headers = headerData2Json();
				if (isEmpty(headers) || headers == "[]") {
					$('#checkbox-header').prop('checked', false);
					$('#checkbox-header').trigger("change");
				} else
					header = headers;

			}

			getToken(url, name, $('#input-cookie').val(), headerData2Json(), {
				success: function(result) {
					console.log(result);
					//window.open("/api/proxy.do?token=" + result);
					$('#result-info').show('500');

					var url = window.location.protocol+"//"+window.location.host+"/api/download/"+result.token;
					var fn = result.data.FileName;
					console.log("fn -> " + fn);
					$('#result-url').attr('href', url);
					$('#result-url').text(url);

					ts2Date = function(timestamp) {
						d = new Date(timestamp * 1000);
						return d.toLocaleDateString().replace(/\//g, "-") + " " + d.toTimeString().substr(0, 8);
					}

					$('#result-create').text(ts2Date(result.data.StartTimeStamp));
					$('#result-expire').text(ts2Date(result.data.ExpireTimeStamp));
					
		  		}, 
		  		error: function(msg) {
		  			showFailed(msg);
		  		}
			});
		});
		$('#checkbox-name').change(function() {
			var checked = $(this).prop('checked');
			if (checked) {
				$('#input-name').show();
			} else {
				$('#input-name').hide();
			}
		});
		$('#checkbox-cookie').change(function() {
			var checked = $(this).prop('checked');
			if (checked) {
				$('#input-cookie').show();
			} else {
				$('#input-cookie').hide();
			}
		});
		$('#checkbox-header').change(function() {
			var checked = $(this).prop('checked');
			if (checked) {
				$('#custom-header-group').show();
			} else {
				$('#custom-header-group').hide();
			}
		});
	});
	</script>
	<!-- particle scripts -->
	<script src="js/particles.js"></script>
	<script src="js/app.js"></script>
	<!--<script src="https://cdn.bootcss.com/flat-ui/2.2.2/js/flat-ui.min.js" type="text/javascript"></script>-->
	
	<script type="text/javascript" src="js/bootstable.js"></script>
	<script type="text/javascript">
		$('#mytable').SetEditable({
			$addButton: $('#add')
		});
	</script>
  <p class="lead copyright">Project GoFileProxy V2.0</p>
</div>
</body>
</html>